# 币安自动交易策略回测系统

基于币安历史真实数据的量化交易策略回测系统，支持72小时连续模拟交易，验证量化策略可行性。

## 功能特性

### 1. 数据获取
- 通过币安API获取历史K线数据（1分钟级别）
- 支持自定义时间跨度（默认72小时）
- 完整的数据字段：开盘价、最高价、最低价、收盘价、成交量
- API限流处理，确保数据完整性
- 支持本地数据加载

### 2. 数据清洗
- 缺失数据检测与处理（插值/跳过）
- 异常值检测（价格突刺、成交量异常）
- 时间戳连续性校验
- 数据格式标准化
- 数据质量报告生成

### 3. 技术指标计算
**趋势类指标：**
- EMA（指数移动平均，支持7/25/99等多周期）
- MACD（移动平均收敛散度）
- 布林带（Bollinger Bands）

**动量类指标：**
- RSI（相对强弱指标）
- KDJ（随机指标）
- Williams %R（威廉指标）

**成交量指标：**
- OBV（能量潮指标）
- 成交量移动平均

**其他：**
- 支撑阻力位识别
- 可配置参数（如均线周期）

### 4. 智能分析与决策引擎
- 多指标综合评分系统（-100到100分）
- 趋势判断：上涨/下跌/震荡
- 买入信号：超卖反弹、突破、金叉等
- 卖出信号：超买回调、跌破、死叉等
- 信号强度评级（强/中/弱）
- 风险评估模块（低/中/高）

### 5. 交易执行模拟
- 初始资金设定（默认1000 USDT）
- 手续费计算：每笔0.1%（Maker/Taker费率）
- 滑点模拟：市价单按不利方向滑动0.05%
- 最小交易量限制
- 仓位管理：根据信号强度动态调整
- 止损/止盈逻辑：固定百分比（2%止损/5%止盈）

### 6. 风险控制
- 单日最大亏损限制（默认5%）
- 连续亏损熔断（默认3次）
- 最大持仓时间限制（默认4小时）
- 急跌保护（5分钟跌超5%暂停交易）
- 最大回撤限制（默认10%）

### 7. 输出与监控
- 实时交易日志（时间、价格、操作、原因）
- 每小时盈亏统计
- 72小时总结报告：
  - 总收益率
  - 最大回撤
  - 胜率
  - 盈亏比
  - 交易次数
  - 夏普比率
- 权益曲线可视化
- 回撤图表
- 失败交易分析报告

## 项目结构

```
.
├── config/                 # 配置文件目录
│   └── config.yaml        # 主配置文件
├── src/                   # 源代码目录
│   ├── __init__.py
│   ├── data_fetcher.py    # 数据获取模块
│   ├── data_cleaner.py    # 数据清洗模块
│   ├── indicators.py      # 技术指标计算
│   ├── strategy.py        # 策略决策引擎
│   ├── trader.py          # 交易执行模拟
│   ├── risk_manager.py    # 风险控制
│   └── monitor.py         # 监控与输出
├── data/                  # 数据目录
├── logs/                  # 日志目录
├── results/               # 回测结果目录
├── main.py               # 主程序入口
├── requirements.txt      # 依赖包列表
└── README.md            # 说明文档
```

## 安装说明

### 1. 环境要求
- Python 3.8+
- pip包管理器

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖包：
- pandas: 数据处理
- numpy: 数值计算
- ccxt: 币安API接口
- PyYAML: 配置文件解析
- matplotlib: 图表绘制（可选）

## 使用说明

### 1. 配置参数

编辑 `config/config.yaml` 文件，配置以下参数：

```yaml
# 交易对
symbol: "BTC/USDT"

# K线周期（1m=1分钟）
timeframe: "1m"

# 回测时长（小时）
hours: 72

# 初始资金（USDT）
trading:
  initial_capital: 1000

# 止损止盈
  stop_loss_percent: 0.02      # 2%止损
  take_profit_percent: 0.05    # 5%止盈

# 风险控制
risk:
  max_daily_loss_percent: 0.05 # 单日最大亏损5%
  max_consecutive_losses: 3    # 连续亏损3次熔断
```

详细配置说明请参考 `config/config.yaml` 文件中的注释。

### 2. 运行回测

**方式1：使用默认配置**
```bash
python main.py
```

**方式2：指定配置文件**
```bash
python main.py --config config/config.yaml
```

### 3. 查看结果

回测完成后，结果将保存在 `results/` 目录：

- `backtest_YYYYMMDD_HHMMSS.log` - 详细日志
- `report_YYYYMMDD_HHMMSS.json` - 总结报告（JSON格式）
- `trades_YYYYMMDD_HHMMSS.csv` - 交易历史（CSV格式）
- `equity_YYYYMMDD_HHMMSS.csv` - 权益曲线（CSV格式）
- `equity_curve_YYYYMMDD_HHMMSS.png` - 权益曲线图表

### 4. 使用本地数据

如果不想每次都调用API，可以使用本地数据：

1. 修改配置文件：
```yaml
use_local_data: true
local_data_file: "data/btc_usdt_1m.csv"
```

2. 准备CSV数据文件，需包含以下列：
   - timestamp（时间戳）
   - open（开盘价）
   - high（最高价）
   - low（最低价）
   - close（收盘价）
   - volume（成交量）

## 策略说明

### 综合评分系统

系统基于多个技术指标计算综合得分（-100到100）：

1. **RSI得分**（-20到20）
   - RSI < 20: +20分（强超卖）
   - RSI < 30: +10分（超卖）
   - RSI > 80: -20分（强超买）
   - RSI > 70: -10分（超买）

2. **KDJ得分**（-20到20）
   - KDJ在超卖区金叉: +20分
   - KDJ在超买区死叉: -20分

3. **MACD得分**（-20到20）
   - MACD金叉: +20分
   - MACD死叉: -20分

4. **布林带得分**（-15到15）
   - 跌破下轨: +15分
   - 突破上轨: -15分

5. **成交量得分**（-10到10）
   - 放量上涨: +10分
   - 放量下跌: -10分

6. **趋势得分**（-15到15）
   - 多头排列: +15分
   - 空头排列: -15分

### 交易信号

- **买入信号**：综合得分 >= 60
- **卖出信号**：综合得分 <= -60
- **持有**：其他情况

信号强度：
- **强信号**：|得分| >= 80
- **中信号**：60 <= |得分| < 80
- **弱信号**：|得分| < 60

## 性能指标说明

### 1. 总收益率
```
总收益率 = (最终资金 - 初始资金) / 初始资金 × 100%
```

### 2. 胜率
```
胜率 = 盈利交易次数 / 总交易次数 × 100%
```

### 3. 盈亏比
```
盈亏比 = 总盈利金额 / 总亏损金额
```

### 4. 最大回撤
```
最大回撤 = (峰值资金 - 当前资金) / 峰值资金 × 100%
```

### 5. 夏普比率
衡量风险调整后的收益，越高越好（通常>1为良好）

## 常见问题

### Q1: 如何调整策略参数？

A: 修改 `config/config.yaml` 中的 `strategy` 和 `indicators` 部分。例如：
- 调整RSI阈值使策略更激进或保守
- 修改EMA周期以适应不同市场
- 调整买入/卖出得分阈值

### Q2: 回测速度慢怎么办？

A:
1. 使用本地数据而非API获取
2. 减少回测时长
3. 使用更大的时间周期（如5m而非1m）

### Q3: 如何评估策略好坏？

A: 关注以下指标：
- 总收益率 > 0
- 胜率 > 50%
- 盈亏比 > 1.5
- 最大回撤 < 10%
- 夏普比率 > 1

### Q4: 可以用于实盘交易吗？

A: 本系统仅用于回测和策略验证。实盘交易需要：
1. 充分的回测验证
2. 模拟盘测试
3. 小资金试运行
4. 完善的监控和预警机制

## 风险提示

1. 历史表现不代表未来收益
2. 回测数据存在过拟合风险
3. 实盘滑点和手续费可能更高
4. 市场环境变化会影响策略表现
5. 量化交易存在技术和市场风险

## 开发计划

- [ ] 支持更多交易对
- [ ] 添加更多技术指标
- [ ] 实现参数优化功能
- [ ] 支持多策略组合
- [ ] 实时监控面板
- [ ] 策略回测对比功能

## 许可证

MIT License

## 联系方式

如有问题或建议，请提交Issue。

---

**免责声明**：本系统仅供学习和研究使用，不构成投资建议。使用本系统进行交易的任何损失，开发者不承担责任。
